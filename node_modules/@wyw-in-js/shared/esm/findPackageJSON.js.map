{"version":3,"file":"findPackageJSON.js","names":["dirname","isAbsolute","findUp","cache","Map","findPackageJSON","pkgName","filename","isJest","Boolean","globalThis","process","env","JEST_WORKER_ID","skipPathsOptions","startsWith","pkgPath","require","resolve","paths","has","set","sync","cwd","get","er","code","undefined"],"sources":["../src/findPackageJSON.ts"],"sourcesContent":["import { dirname, isAbsolute } from 'path';\nimport findUp from 'find-up';\n\nconst cache = new Map<string, string | undefined>();\n\nexport function findPackageJSON(\n  pkgName: string,\n  filename: string | null | undefined\n) {\n  // Jest's resolver does not work properly with `moduleNameMapper` when `paths` are defined\n  const isJest = Boolean(globalThis.process?.env?.JEST_WORKER_ID);\n  const skipPathsOptions = isJest && !pkgName.startsWith('.');\n\n  try {\n    const pkgPath =\n      pkgName === '.' && filename && isAbsolute(filename)\n        ? filename\n        : require.resolve(\n            pkgName,\n            filename ? { paths: [dirname(filename)] } : {}\n          );\n    if (!cache.has(pkgPath)) {\n      cache.set(pkgPath, findUp.sync('package.json', { cwd: pkgPath }));\n    }\n\n    return cache.get(pkgPath);\n  } catch (er: unknown) {\n    const code =\n      typeof er === 'object' && er !== null && 'code' in er\n        ? er.code\n        : undefined;\n\n    if (code === 'MODULE_NOT_FOUND') {\n      if (skipPathsOptions && filename) {\n        return findPackageJSON(pkgName, null);\n      }\n\n      return undefined;\n    }\n\n    if (code === 'ERR_PACKAGE_PATH_NOT_EXPORTED') {\n      // See https://github.com/Anber/wyw-in-js/issues/43\n      // `require` can't resolve ESM-only packages. We can use the `resolve`\n      // package here, but it does not solve all cases because `pkgName`\n      // can be an alias and should be resolved by a bundler. However, we can't use\n      // `resolve` from a bundler because it is async. The good news is that in that\n      // specific case, we can just ignore those packages. For now.\n      return undefined;\n    }\n\n    throw er;\n  }\n}\n"],"mappings":"AAAA,SAASA,OAAO,EAAEC,UAAU,QAAQ,MAAM;AAC1C,OAAOC,MAAM,MAAM,SAAS;AAE5B,MAAMC,KAAK,GAAG,IAAIC,GAAG,CAA6B,CAAC;AAEnD,OAAO,SAASC,eAAeA,CAC7BC,OAAe,EACfC,QAAmC,EACnC;EACA;EACA,MAAMC,MAAM,GAAGC,OAAO,CAACC,UAAU,CAACC,OAAO,EAAEC,GAAG,EAAEC,cAAc,CAAC;EAC/D,MAAMC,gBAAgB,GAAGN,MAAM,IAAI,CAACF,OAAO,CAACS,UAAU,CAAC,GAAG,CAAC;EAE3D,IAAI;IACF,MAAMC,OAAO,GACXV,OAAO,KAAK,GAAG,IAAIC,QAAQ,IAAIN,UAAU,CAACM,QAAQ,CAAC,GAC/CA,QAAQ,GACRU,OAAO,CAACC,OAAO,CACbZ,OAAO,EACPC,QAAQ,GAAG;MAAEY,KAAK,EAAE,CAACnB,OAAO,CAACO,QAAQ,CAAC;IAAE,CAAC,GAAG,CAAC,CAC/C,CAAC;IACP,IAAI,CAACJ,KAAK,CAACiB,GAAG,CAACJ,OAAO,CAAC,EAAE;MACvBb,KAAK,CAACkB,GAAG,CAACL,OAAO,EAAEd,MAAM,CAACoB,IAAI,CAAC,cAAc,EAAE;QAAEC,GAAG,EAAEP;MAAQ,CAAC,CAAC,CAAC;IACnE;IAEA,OAAOb,KAAK,CAACqB,GAAG,CAACR,OAAO,CAAC;EAC3B,CAAC,CAAC,OAAOS,EAAW,EAAE;IACpB,MAAMC,IAAI,GACR,OAAOD,EAAE,KAAK,QAAQ,IAAIA,EAAE,KAAK,IAAI,IAAI,MAAM,IAAIA,EAAE,GACjDA,EAAE,CAACC,IAAI,GACPC,SAAS;IAEf,IAAID,IAAI,KAAK,kBAAkB,EAAE;MAC/B,IAAIZ,gBAAgB,IAAIP,QAAQ,EAAE;QAChC,OAAOF,eAAe,CAACC,OAAO,EAAE,IAAI,CAAC;MACvC;MAEA,OAAOqB,SAAS;IAClB;IAEA,IAAID,IAAI,KAAK,+BAA+B,EAAE;MAC5C;MACA;MACA;MACA;MACA;MACA;MACA,OAAOC,SAAS;IAClB;IAEA,MAAMF,EAAE;EACV;AACF"}